<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listings</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="card">
    <h2>Listings</h2>
    <ul id="results"></ul>
    <button id="logout">Log out</button>
  </div>
  <script>
    const REFRESH_MS = 60000;

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('loggedIn') !== 'true') {
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('logout').addEventListener('click', function () {
        localStorage.removeItem('loggedIn');
        window.location.href = 'login.html';
      });

      const resultsList = document.getElementById('results');

      async function loadResults() {
        try {
          const response = await fetch('search_results.json?_=' + Date.now());
          const data = await response.json();
          resultsList.innerHTML = '';
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'result-item';

            const img = document.createElement('img');
            const url = new URL(item.href);
            img.src = 'https://www.google.com/s2/favicons?domain=' + url.hostname;
            img.alt = (item.company || url.hostname) + ' logo';

            const info = document.createElement('div');
            info.className = 'result-info';

            const link = document.createElement('a');
            link.href = item.href;
            link.textContent = item.title;
            link.target = '_blank';
            link.className = 'result-title';

            const company = document.createElement('div');
            company.className = 'result-company';
            if (item.company) {
              company.textContent = item.company;
            } else {
              const hostParts = url.hostname.replace('www.', '').split('.');
              company.textContent = hostParts[hostParts.length - 2] || url.hostname;
            }

            const desc = document.createElement('div');
            desc.className = 'result-description';
            desc.textContent = item.body || '';

            info.appendChild(link);
            info.appendChild(company);
            info.appendChild(desc);

            li.appendChild(img);
            li.appendChild(info);

            resultsList.appendChild(li);
          });
        } catch (e) {
          console.error('Failed to load results', e);
        }
      }

      loadResults();
      setInterval(loadResults, REFRESH_MS);
    });
  </script>
</body>
</html>
